---
layout: post
title: 데이터중심 애플리케이션 설계 - 파티셔닝
subtitle: 6장 파티셔닝
categories: book
tags: [partitioning]
---

# 목차

## 1. 파티셔닝
- 이번장에서 다루는 파티셔닝은 대용량 데이터베이스를 의도적으로 작은단위로 쪼개는 방법인 샤딩을 뜻함.
- 파티셔닝을 원하는 주된 이유는 '확장성'
- 대용량 데이터셋을 파티셔닝 하는 몇가지 방법을 소개한다.
- 파티셔닝의 리벨런싱(재균형화)에 대해서도 소개한다.
- 데이터베이스가 어떻게 요청을 올바른 파티션에 전달하고 질의를 실행하는지 개략적으로 알아볼 예정

## 2. 키-값 데이터 파티셔닝
- 파티셔닝의 목적은 데이터와 질의 부하를 노드 사이에 고르게 분산시키는 것임
- 근데 파티셔닝이 고르게 이뤄지지 않으면? 
    - 다른 파티션보다 부하를 받는 파티션이 생기게 될텐데 이처럼 불균형하게 부하가 높은 파티션을 핫스팟 이라 부름
- 핫스팟을 회피하기 좋은 방법으로 키-값 데이터 모델(키 범위 기준, 키 해시값 기준)을 사용

### 2-1. 키 범위 기준 파티셔닝
- 종이 백과사전처럼 각 파티션에 연속된 범위의 키를 할당하는 것
    - 각 범위들 사이의 경계를 알면 어떤 키가 어떤 파티션에 있는지 쉽게 찾을 수 있다.
- 키 범위의 크기가 반드시 동일할 필요는 없다.
    - why? 데이터가 고르게 분포하지 않을 수도 있기 때문
        - ex) 파티션은 12개, 키는 26개인 케이스에서 키의 범위를 2개씩만 동일하게 설정할 경우
              마지막 파티션에는 2개 이상의 키가 범위로 잡히게 된다.
    - 데이터를 고르게 분산시키려면 파티션 경계를 데이터에 맞춰 조정해야 한다.
        - 이는 관리자가 수동으로 선택 or DB 가 자동으로 선택할 수 있다. (파티션 재균형화에서 계속)
- 각 파티션 내에서는 키를 정렬된 순서로 저장할 수 있다.

### 2-2. 키 해시값 기준 파티셔닝
- 쏠림현상과 핫스팟 위험 때문에 많은 분산 데이터스토어에서는 해시함수를 사용한다.
- 키에 적합한 해시함수를 구하고, 각 파티션에 키 범위 대신 해시값 범위를 할당하고 해시값이
파티션의 범위에 속하는 모든 키를 해당 파티션에 할당한다. (consistence hashing)
- 대신 범위 질의를 효율적으로 실행할 수 없다. (키가 해시함수로 바뀌면서 모든 파티션에 흩어질거니까..)    
#### 쏠린 작업부하와 핫스팟 완화
- 해시값 기준으로 파티셔닝 시 핫스팟을 줄이는데 도움은 되지만 완벽히 제거할 순 없다.
    - 항상 동일한 키를 읽고 쓰는 극단적 상황에서는... 모든 요청이 동일한 파티션으로 간다..
    - 이런 극단적 상황이 발생할 경우 애플리케이션에서 쏠림을 완화해야 한다.
    - ex) 키의 시작이나 끝에 임의의 숫자를 붙인다. 등..
        - 임의의 숫자를 붙임으로서 한 키에 대한 쓰기 작업이 다른 키로 균등하게 분산되고 다른파티션으로 분산될테니

## 3. 보조색인 파티셔닝
- 위에서 설명한 키-값 데이터 모델은 레코드를 기본 키를 통해서만 접근한다.
- 보조 색인이 있는 데이터베이스를 파티셔닝 하는데 쓰이는 방법에 대해 알아보자.

### 3-1. 문서 기준 보조 색인 파티셔닝
https://github.com/user-attachments/assets/5e6949ac-8ed0-4eba-a5e4-8f1798e4c254
- 예시로 알아보겠음
- 예를 들어 중고차를 판매하는 웹사이트를 운영한다고 가정, 각 항목에는 문서ID 라 부르는 고유 ID 가 있고 데이터베이스를 문서ID 기준으로
파티셔닝 한다.
- 사용자들이 차를 검색 시 색상과 제조사로 필터링하게 하려면 color 와 make 에 보조 색인을 만든다.
    - 색인을 선언했다면 DB가 자동으로 색인 생성을 할 수 있다.
- 이럴 경우 각 파티션은 완전히 독립적으로 동작한다.
- 각 파티션은 자신의 보조색인을 유지, 파티션에 속하는 문서만 담당
    - 따라서 문서 파티셔닝 색인은 지역색인(local index) 이라고도 한다.  
- 모든 파티션으로 질의를 보내 얻은 결과를 모두 모아야 되는 단점이 있다.
    - 이 방법을 스캐터/개더 방식이라고도 한다.
    - 이래서 데이터베이스 벤더들은 대부분 보조 색인 질의가 단일 파티션에서만 실행되도록
    단파티셔닝 방식을 설계하기를 권장한다.

### 3-2. 용어 기준 보조 색인 파티셔닝
https://github.com/user-attachments/assets/20947641-0f84-474e-b1f9-0552a91960c1
- 문서 기준 보조 색인처럼 지역색인하지말고 전역색인 하면 되지않을까?
    - 그치만 한 노드에만 색인을 저장할 순 없다. 해당 노드에 병목되면?
    - 그래서 전역색인도 결국 파티셔닝을 해야하는데 기본키 색인과는 다른 식으로 할 수 있다.
- 그림을 보면 확인할 수 있는데 컬러 알파벳의 a~r 까지는 파티션0 에 색인, s~z 까지는 파티션1에 색인
- 찾고자 하는 용어에 따라 색인의 파티션이 결정되므로 용어 기준으로 파티셔닝됐다고 한다.
- 여기서 용어란 문서에 등장하는 모든 단어를 뜻한다.
- 용어 자체로 파티셔닝 시 범위 스캔에 유용하며
- 용어의 해시값으로 파티셔닝 시 부하가 더 고르게 분산된다.
- 문서 파티셔닝 색인에 비해 읽기가 효율적인 장점이 있다.
    - 모든 파티션에 스캐터/개더를 실행할 필요 없이 용어를 포함하는 파티션으로만 요청을 보내면 되니까
- 문서 파티셔닝 색인에 비해 쓰기가 느리다는 단점이 있다.
    - 단일 문서를 쓸 때 해당 색인의 여러 파티션에 영향을 줄 수 있기 때문
- 현실에서 전역 보조 색인은 대개 비동기로 갱신된다.
    - 쓰기 실행 후 바로 조회 시 반영 안될 수 있다.

## 4. 파티션 재균형화 (리밸런싱)
- 리벨런싱 : 클러스터에서 한 노드가 담당하던 부하를 다른 노드로 옮기는 과정
- 리벨런싱 실행 시 만족 시킬 것으로 기대되는 최소 요구사항
    - 리벨런싱 후 부하가 클러스터 내에 있는 노드들 사이 균등하게 분배
    - 리벨런싱 도중에도 데이터베이스 읽쓰기 요청 받아들여야 함
    - 노드들 사이 데이터가 필요 이상으로 옮겨지면 안됨 (속도 이슈)

### 4-1. 재균형화 전략
### 4-2. 파티션 개수 고정 파티셔닝
- 파티션을 노드 대수 보다 많이 만들고 각 노드에 여러 파티션을 할당 하는 것
- 클러스터에 노드 추가 시 새 노드는 파티션이 균일하게 분배될 때 까지 기존 노드에 있는 파티션 몇개를 뺏어온다.
- 리밸런싱 중 들어오는 요청은 기존에 할당된 파티션을 사용
- 장점 : 파티션을 통째로 이동, 그저 노드만 바뀔 뿐
- 단점 : 파티션 수는 고정인데 전체 데이터셋 크기 변동이 심할경우 적절한 파티션 수 지정이 어렵다.
    - 대부분 처음 설정된 파티션 수 = 사용 가능한 노드 대수의 최대치
    - 개별 파티션 크기는 클러스터 전체 데이터 크기에 비례한다.
        - 파티션을 너무 크게 나누면 리밸런싱 작업이나 노드 장애 복구 시 비용이 많이든다. (크기가 크니까)
        - 파티션을 너무 작게 나누면 오버헤드가 너무 커진다. (리밸런싱 시 파티션 이동 작업 횟수 증가 등..)            
- 리악, 엘라스틱서치, 카우치베이스, 볼드모트 에서 사용됨

### 4-3. 동적 파티셔닝
- HBase 나 리싱크DB 는 파티션을 동적으로 만든다.
- 파티션 개수가 전체 데이터 용량에 맞춰 조정된다는 이점이 있다.
- 빈 데이터베이스의 경우 파티션 경계에 대한 사전 정보가 없으므로 시작 시 파티션이 하나라는 함정이 있음
    - 이 문제를 완화하려고 초기 파티션 집합을 설정할 수 있게 함

### 4-4. 노드 비례 파티셔닝
- 카산드라와 케타마 에서 사용하고 있으며 파티션 개수가 노드 대수에 비례하게 하는 것
- 노드 당 파티션 개수를 고정 한다.
- 일반적으로 데이터 용량이 증가할 수록 노드도 많이 필요하므로 이 방법을 쓰면 개별 파티션 크기도 상당히 안정적으로 유지 됨
- 단점으로 신규 노드 추가로 파티션 분할 시 무작위로 분할되긴 하나 consistence hashing 기법을 사용하면 된다.

## 5. 운영 시 리밸런싱 (자동 or 수동)
- 완전 자동 재균형화
    - 유지보수에 손이 덜 가므로 편리할 수 있으나 예측이 어렵기도 하다.
- 리밸런싱 과정에서 사람이 개입하는게 좋을 수도 있다. (승인해주기)

## 6. 요청 라우팅
https://github.com/user-attachments/assets/614d77a0-3a7d-45be-835d-d761ef748af0
- 서비스 디스커버리의 일종이다.
- 많은 분산 데이터 시스템은 클러스터 메타데이터를 추적하기 위해 별도의 코디네이션 서비스를 사용함( ex. 주키퍼, k8s의 컨트롤플레인)

## 정리
- 주요 파티셔닝 기법
    - 키범위 파티셔닝
    - 키 해시 파티셔닝
- 보조색인 파티셔닝 기법
    - 문서 파티셔닝 색인
    - 용어 파티셔닝 색인


