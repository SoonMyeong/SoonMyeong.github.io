<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>대규모시스템설계기초- 5장 안정 해시 설계 | SoonWorld</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="대규모시스템설계기초- 5장 안정 해시 설계" />
<meta name="author" content="Soon" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="대부분의 그림 출처 : https://donghyeon.dev/인프라/2022/03/20/안정-해시-설계/" />
<meta property="og:description" content="대부분의 그림 출처 : https://donghyeon.dev/인프라/2022/03/20/안정-해시-설계/" />
<link rel="canonical" href="https://soonmyeong.github.io/jekyll-theme-yat/book/2024/05/18/consistent-hash.html" />
<meta property="og:url" content="https://soonmyeong.github.io/jekyll-theme-yat/book/2024/05/18/consistent-hash.html" />
<meta property="og:site_name" content="SoonWorld" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-18T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="대규모시스템설계기초- 5장 안정 해시 설계" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Soon"},"dateModified":"2024-05-18T00:00:00+00:00","datePublished":"2024-05-18T00:00:00+00:00","description":"대부분의 그림 출처 : https://donghyeon.dev/인프라/2022/03/20/안정-해시-설계/","headline":"대규모시스템설계기초- 5장 안정 해시 설계","mainEntityOfPage":{"@type":"WebPage","@id":"https://soonmyeong.github.io/jekyll-theme-yat/book/2024/05/18/consistent-hash.html"},"url":"https://soonmyeong.github.io/jekyll-theme-yat/book/2024/05/18/consistent-hash.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="icon" href="">
  <link rel="canonical" href="https://SoonMyeong.github.io">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/jekyll-theme-yat/assets/css/main.css">
  <script src="/jekyll-theme-yat/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="https://soonmyeong.github.io/jekyll-theme-yat/feed.xml" title="SoonWorld" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8"
        src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"
        async></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
<script
  src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe-lightbox.umd.min.js" async></script>
<script
  src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe.umd.min.js" async></script>
<link
  href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.min.css"
  rel="stylesheet"
/>
<style>
  .pswp .pswp__container .pswp__img {
    background-color: white;
  }
</style>

<script>
  function initPhotoSwipe() {
    let customOptions = {};

    try {
      const data = ``.replaceAll("=>", ":");
      customOptions = JSON.parse(data);
    } catch (e) {
      console.info("Invalid custom photo previewer options! " + e.message);
    }

    // Define object and gallery options
    const options = Object.assign(
      {
        gallery: "section.main",
        children: "a.photo-swipe",
        photo_scale: 2,
        // dynamic import is not supported in UMD version
        pswpModule: PhotoSwipe,
      },
      customOptions
    );

    const galleryEl = document.querySelector(options.gallery);
    if (!galleryEl) {
      return;
    }

    const imgEls = [];
    const els = galleryEl.querySelectorAll("img:not(.emoji)");
    els.forEach((el) => {
      if (el.src.trim() == "") {
        return;
      }
      if (!imgEls.includes(el)) {
        imgEls.push(el);
      }
    });

    if (imgEls.length === 0) {
      return;
    }

    imgEls.forEach((imgEl) => {
      imgEl.outerHTML = `
      <a class="photo-swipe"
        href="${imgEl.src}"
        data-pswp-width="${
          Math.max(imgEl.naturalWidth, imgEl.width) * options.photo_scale
        }"
        data-pswp-height="${
          Math.max(imgEl.naturalHeight, imgEl.height) * options.photo_scale
        }"
        data-pswp-caption="${imgEl.getAttribute("caption") || imgEl.alt}"
        target="_blank">
        ${imgEl.outerHTML}
      </a>`;
    });

    // Initialize PhotoSwipe 5
    var lightbox = new PhotoSwipeLightbox(options);

    lightbox.init();
  }

  window.addEventListener("load", initPhotoSwipe);
</script>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner"><span class="site-brand"><a class="site-brand-inner" rel="author" href="/jekyll-theme-yat/">
  <img class="site-favicon" title="SoonWorld" src="" onerror="this.style.display='none'">
  SoonWorld
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>

          <div class="trigger"><a class="page-link" href="/jekyll-theme-yat/about.html">ABOUT</a><a class="page-link" href="/jekyll-theme-yat/archives.html">ARCHIVES</a><a class="page-link" href="/jekyll-theme-yat/categories.html">CATEGORIES</a><a class="page-link" href="/jekyll-theme-yat/">HOME</a><a class="page-link" href="/jekyll-theme-yat/tags.html">TAGS</a>









<span class="page-link">



<div id="google_translate_element" style="display: none;">
</div>

<span class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="fr">
          
          <img src="https://cdn.countryflags.com/thumbs/france/flag-400.png" title="French">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="zh-CN">
          
          <img src="https://cdn.countryflags.com/thumbs/china/flag-400.png" title="Chinese(Simple)">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ja">
          
          <img src="https://cdn.countryflags.com/thumbs/japan/flag-400.png" title="Japanese">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ko">
          
          <img src="https://cdn.countryflags.com/thumbs/south-korea/flag-400.png" title="Korean">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ru">
          
          <img src="https://cdn.countryflags.com/thumbs/russia/flag-400.png" title="Russian">
          
        </a>
      </li>
    
  </ul>
</span>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>
</span></div>
        </nav></div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">대규모시스템설계기초- 5장 안정 해시 설계</h1>
  <h2 class="post-subtitle">안정 해시 설계</h2>

  <div class="post-meta">
    <time class="dt-published" datetime="2024-05-18T00:00:00+00:00" itemprop="datePublished"><i class="fa fa-calendar"></i> May 18, 2024
    </time>
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 5 mins</span>
  </div><div class="post-tags"><a class="post-tag" href="/jekyll-theme-yat/tags.html#hash">#hash</a><a class="post-tag" href="/jekyll-theme-yat/tags.html#consistent hash">#consistent hash</a></div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p>대부분의 그림 출처 : <a href="https://donghyeon.dev/%EC%9D%B8%ED%94%84%EB%9D%BC/2022/03/20/%EC%95%88%EC%A0%95-%ED%95%B4%EC%8B%9C-%EC%84%A4%EA%B3%84/">https://donghyeon.dev/인프라/2022/03/20/안정-해시-설계/</a></p>

<h3 id="들어가면서-">들어가면서 …</h3>

<p>수평적 규모 확장성을 달성하기 위해 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다.</p>

<ul>
  <li>안정 해시는 이 목표를 달성하기 위해 보편적으로 사용하는 기술이다.</li>
</ul>

<h3 id="해시-키-재배치rehash-문제-안정해시가-나오게-된-배경">해시 키 재배치(rehash) 문제 (안정해시가 나오게 된 배경)</h3>

<p>N개의 서버를 균등하게 나누는 보편적 방법은 아래 해시 함수를 사용하는 것이다.</p>

<ul>
  <li>serverIndex = hash(key) % N (N : 서버 개수) - 모듈러 연산</li>
</ul>

<h3 id="모듈러-연산-예제">모듈러 연산 예제</h3>

<p>서버가 4대 인 경우</p>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/2ada9666-991b-4347-98b0-e5e1c3bdf4a3" alt="image" /></p>

<ul>
  <li>대략적인 해시와 모듈러연산 결과 표</li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/02477f78-e561-4093-afa8-203126299c5c" alt="image" /></p>

<ul>
  <li>서버 <strong>풀의 크기가 고정</strong>되어 있을 때 &amp; <strong>데이터 분포가 균등</strong>할 때는 잘 동작한다.</li>
  <li><strong>서버가 추가되거나 기존 서버가 삭제 되면 문제가 생긴다.</strong></li>
</ul>

<h3 id="위-예제에서-1번-서버가-장애를-일으켜-동작을-중단했을-경우">위 예제에서 1번 서버가 장애를 일으켜 동작을 중단했을 경우</h3>

<ul>
  <li>해시 값은 변하지 않지만 모듈러 연산을 적용하여 계산된 <strong>서버 인덱스 값은 달라지게 됨</strong>
    <ul>
      <li>serverIndex = hash(key) % N (N : 서버 개수) 해당 계산 식에서 N 값이 바뀌었기 때문</li>
    </ul>
  </li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/7fb360fd-3522-465b-9acd-d30ee32e98be" alt="image" /></p>

<ul>
  <li>서버 개수의 변화로 모듈러연산 결과가 이전과 완전 다르게 바뀌었다.</li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/8d080f8d-b9bd-41c8-9a8f-8fa054fd0f65" alt="image" /></p>

<ul>
  <li>결과로 대부분의 키가 재분배 되었다.</li>
  <li><strong>안정해시는 이 문제를 효과적으로 해결하기 위한 기술이다.</strong></li>
</ul>

<h2 id="안정해시">안정해시</h2>

<ul>
  <li>해시테이블 크기가 조정될 때 평균적으로 오직 k/n 개의 키만 재배치하는 해시 기술
    <ul>
      <li>k: 키의 개수, n : 슬롯 개수</li>
    </ul>
  </li>
</ul>

<h3 id="해시-공간과-해시-링">해시 공간과 해시 링</h3>

<ul>
  <li>해시 공간
    <ul>
      <li>해시 함수 f는 SHA(Secure Hash Algorithm)-1을 사용한다고 가정.
        <ul>
          <li>근데 SHA-1 은 해시충돌이 발견되어 현재 지원은 중단된 상태
            <ul>
              <li>https://cpuu.postype.com/post/580053</li>
            </ul>
          </li>
          <li>아마 보통은 SHA-2 를 쓸 것임
            <ul>
              <li>우리가 흔히 알고있는 SHA-256, SHA-512, SHA-224, SHA-384 를 통칭 하여 SHA-2 라고 부른다고 함</li>
              <li>2015년에 나온 SHA-3 도 있음..</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>SHA-1의 해시 공간 범위는 2^160 -1 까지라 알려져 있다는데 모듈러 연산결과는 x0(0) ~ xn(2^160 -1) 의 값을 갖게 될 것이다. 이걸 해시 공간이라 부른다.</li>
    </ul>
  </li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/f288371e-b2e1-4f7a-ad2e-36df98be5e62" alt="image" /></p>

<ul>
  <li>해시 링
    <ul>
      <li>이러한 해시 공간의 양쪽을 구부려 접은걸 해시 링 이라고 한다.</li>
    </ul>
  </li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/beb57cd8-f453-4c59-9b11-30d3b8ab425a" alt="image" /></p>

<h3 id="해시-서버--해시-키">해시 서버 &amp; 해시 키</h3>

<ul>
  <li>균등분포 해시함수를 사용하여 서버 IP 나 이름 같은걸 해시 링에 배치한 결과</li>
  <li>모듈러 연산을 사용하지 않음</li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/a58d28eb-7876-4afd-97a6-b68a2fa8a062" alt="image" /></p>

<h3 id="서버-조회-시">서버 조회 시</h3>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/a7ebead9-4808-467a-bb7f-baee4d311505" alt="image" /></p>

<ul>
  <li>key는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버에 저장 된다.</li>
</ul>

<h3 id="서버-추가-시">서버 추가 시</h3>

<ul>
  <li>서버 추가 시 키 가운데 일부만 재배치하면 된다.</li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/ddab5c80-1608-4876-833d-05fab8814206" alt="image" /></p>

<h3 id="서버-제거-시">서버 제거 시</h3>

<ul>
  <li>key 1만 재배치 되었다.</li>
</ul>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/330144ab-d7b3-4319-bd72-7ba1f3e9617e" alt="image" /></p>

<h2 id="위-구현법의-2가지-문제">위 구현법의 2가지 문제</h2>

<ul>
  <li>파티션의 크기를 균등하게 유지하는 게 불 가능하다.(위 예제 처럼)
    <ul>
      <li>여기서 말하는 파티션 : 인접한 서버 사이의 해시 공간</li>
    </ul>
  </li>
  <li>키의 균등 분포를 달성하기가 어렵다.</li>
</ul>

<h2 id="가상-노드">가상 노드</h2>

<ul>
  <li>위 문제를 해결하기 위해 제안된 기법</li>
  <li>하나의 서버는 링 위에 여러개의 가상 노드를 가질 수 있다.</li>
</ul>

<h3 id="예제">예제</h3>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/4e3ff0b1-7b8a-4a06-9003-e109379137b0" alt="image" /></p>

<ul>
  <li>서버0과 서버1은 각각 3개의 가상노드를 가지고 있다.</li>
  <li>따라서 각 서버는 여러개의 파티션을 관리해야 한다.
    <ul>
      <li>서버0 : 서버0_0, 서버0_1, 서버0_2 파티션 관리</li>
      <li>서버1: 서버1_0, 서버1_1, 서버1_2 파티션 관리</li>
    </ul>
  </li>
</ul>

<h3 id="위-예제에서-키가-들어오게-되면-어떻게-배치되는지">위 예제에서 키가 들어오게 되면 어떻게 배치되는지</h3>

<p><img src="https://github.com/SoonMyeong/programmers/assets/31875043/08749210-9646-4d98-9d18-a305356c6ce6" alt="image" /></p>

<ul>
  <li>기존 해시링에서 키를 저장하는 방법과 동일하게 key를 기준으로 시계방향으로 돌면서 가장 먼저 만나는 가상노드가 나타내는 서버에 저장되게 된다.</li>
  <li>
    <p>key0 는 최초로 만나게되는 서버는 가상노드 서버1_1이고, 결국 key0 은 서버 1에 저장된다.</p>
  </li>
  <li>가상노드의 개수를 늘리면 키의 분포는 점점 더 균등해진다. (표준편차가 작아져서)</li>
  <li>대신 그만큼 가상노드를 저장할 공간이 더 필요하게 된다.
    <ul>
      <li>타협적 결정이 필요함</li>
      <li>한마디로 <strong>시스템 요구사항에 맞게 적절히 조정해야 함</strong> (알잘딱깔센, 제일 어려운 말)</li>
    </ul>
  </li>
</ul>

<h2 id="마치며">마치며</h2>

<ul>
  <li>안정 해시의 장점
    <ul>
      <li>서버 추가 or 삭제 시 재배치 되는 키의 수가 최소화 된다.</li>
      <li>데이터가 보다 균등하게 분포되어 수평적 규모 확장성을 달성하기 쉽다.
        <ul>
          <li>핫스팟 키 문제를 줄인다. 특정 샤드에 대한 접근이 지나치게 빈번해지는 문제가 생길 가능성을 줄인다.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="실제-안정-해시를-쓰는-예">실제 안정 해시를 쓰는 예</h3>

<ul>
  <li>
    <p><a href="https://dl.acm.org/doi/10.1145/1294261.1294281">아마존 다이나모 DB 파티셔닝 관련 컴포넌트</a> <br />
  <img src="https://github.com/SoonMyeong/programmers/assets/31875043/734db5a3-1780-434d-9b2f-dde50c39b990" alt="image" /></p>
  </li>
  <li><a href="https://www.cs.cornell.edu/Projects/ladis2009/papers/lakshman-ladis2009.pdf">아파치 카산드라 클러스터에서의 데이터 파티셔닝</a>
    <ul>
      <li>5.1 파티셔닝 부분</li>
      <li>The basic consistent hashing algorithm presents some challenges.
  First, the random position assignment of each node on the
  ring leads to non-uniform data and load distribution. Second, the basic algorithm is oblivious to the heterogeneity in the performance of nodes
        <ul>
          <li>문서 내용을 보면 책에서 말한 설명을 그대로 하고 있음</li>
        </ul>
      </li>
      <li>One is for nodes to get assigned to multiple positions in the circle (like in Dynamo), and the second is to analyze load information on the ring and have lightly loaded nodes move on the ring to alleviate heavily loaded nodes as described in [17]. Cassandra opts for the latter as it makes the design and implementation very tractable and helps to make very deterministic choices about load balancing
        <ul>
          <li>얘네는 노드가 다이나모DB 처럼 원의 여러 위치에 노드가 할당되는 방법말고 링에 부하되는 정보를 분석해 노드를 링 에서 움직여 과도한 로드를 완화하는 방법을 쓴다고 함</li>
          <li>이게 설계와 구현을 다루기 쉽다나 뭐라나..</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>디스코드
    <ul>
      <li>참고 문헌 주소 보고 들어가도 자꾸 메인으로 나가짐 어디 있는지 모르겠음→ 패스</li>
    </ul>
  </li>
  <li><a href="https://theory.stanford.edu/~tim/s16/l/l1.pdf">아카마이(Akamai) CDN</a>  <br />
  <img src="https://github.com/SoonMyeong/programmers/assets/31875043/b9fa21a8-1979-4d9e-8375-797de09c90a0" alt="image" />
    <ul>
      <li>여기서도 책에서 말한 내용들이 그대로 적혀 있음</li>
      <li>Consistent hashing remains in use in modern P2P networks, including for some features
  of the BitTorrent protocol.
        <ul>
          <li>P2P 에서도 일관된 해싱을 사용하나봄</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>매그레프(Meglev) 네트워크 부하 분산기
    <ul>
      <li>lookup 테이블 관련된 해싱 얘기가 나오긴 하는데.. 읽다 잘 모르겠어서 접음</li>
    </ul>
  </li>
</ul>


    </div>

</article>
<div class="post-nav"><span></span><a class="next" href="/jekyll-theme-yat/book/2024/06/18/web-crawler.html" title="대규모시스템설계기초- 9장 웹크롤러 설계">대규모시스템설계기초- 9장 웹크롤러 설계</a></div><div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li class="">
          <a class="post-link"
            href="/jekyll-theme-yat/book/2024/07/31/data-model-and-query.html"
            title="데이터중심 애플리케이션 설계 - 2장 데이터 모델과 질의 언어">
            데이터중심 애플리케이션 설계 - 2장 데이터 모델과 질의 언어<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li><li class="">
          <a class="post-link"
            href="/jekyll-theme-yat/book/2024/06/18/web-crawler.html"
            title="대규모시스템설계기초- 9장 웹크롤러 설계">
            대규모시스템설계기초- 9장 웹크롤러 설계<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li><li class="">
          <a class="post-link"
            href="/jekyll-theme-yat/book/2024/05/18/consistent-hash.html"
            title="대규모시스템설계기초- 5장 안정 해시 설계">
            대규모시스템설계기초- 5장 안정 해시 설계<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li><li class="">
          <a class="post-link"
            href="/jekyll-theme-yat/book/2024/09/22/partitioning.html"
            title="데이터중심 애플리케이션 설계 - 파티셔닝">
            데이터중심 애플리케이션 설계 - 파티셔닝<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li></ul>
    </div><div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/jekyll-theme-yat/"></data>

  <div class="wrapper">
    <div class="site-footer-inner"><div>Unpublished Work <span class="copyleft">&copy;</span> 2017-2024 Soon</div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
      <div class="footer-col rss-subscribe">Subscribe <a href="/jekyll-theme-yat/feed.xml">via RSS</a></div>
    </div>
  </div>
</footer>
</body>
</html>
